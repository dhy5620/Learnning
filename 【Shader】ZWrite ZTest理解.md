# 深度测试DepthTest】ZWrite、ZTest详解 

## 一 名词解释

### 1 Z深度

深度其实就代表该像素在世界空间中距离摄像机的距离。离相机越远，深度值(Z)越大;

### 2 缓冲区

【颜色缓冲区】：也叫帧缓冲区，场景中的物体的像素都要写入该缓冲区，然后再渲染到屏幕上显示
【深度缓冲区】：用于记录颜色缓冲区中每个像素的深度值，通过深度缓冲区，我们可以通过深度测试来确定像素的遮挡关系
【模版缓冲区】：与深度缓冲类似，但这个值是可以自己设定的。,通过设置每个像素的模板缓冲值，就可以指定只渲染某些像素，用于实现类似遮罩之类的效果。

深度缓冲区中存储着准备要绘制在屏幕上的像素点的深度值。如果启用深度缓冲区，在绘制每个像素之前，会把该像素的深度值和深度缓冲区的深度值进行比较。如果新像素深度值 < 深度缓存深度值，则新像素值取代本来该点的值，缓冲区的深度值也替换成新像素点的深度值；反之，新像素值被遮挡，其颜色值和深度将被丢弃。

### 3 深度测试

深度测试默认情况是将要绘制的新像素的z值与深度缓冲区对应位置的z值的进行比较，如果比深度缓存中的值小，就用新像素的颜色值更新深度缓冲中对应像素的颜色值。

#### 4 为什么需要深度

如果不使用深度测试，后绘制的物体会把先绘制的物体覆盖掉。有了深度缓冲后，绘制顺序就不那么重要，可以按照远近（z值）来正常显示。（会完全按照渲染队列的顺序进行渲染）

### 5 透明测试

透明测试开启时，当前像素根据设定条件决定是否输出颜色

### 6 深度测试ZTest、透明测试AlphaTest、混合模式Blend的关系

总的来说深度测试ZTest决定遮挡关系，是否用当前像素替换缓存像素
透明测试alphatest决定是否显示透明度达标的像素
颜色混合blend决定通过测试的像素如果重合如何显示

## ZWrite

ZWrite On | Off

ZWrite可以取的值为：On/Off，默认值为On，代表是否要将像素的深度写入深度缓存中(同时还要看ZTest是否通过)。

## ZTest

【当前像素】 当前像素就是指当前shader脚本所属的模型像素
【缓存限速】 准备输出到屏幕上的像素，被称为缓存像素
【深度测试】 实际上就是描述如何确定缓存像素的规则
【启用深度测试的必要条件】ZWrite、ZTest同时不为Off

ZTest Less | Greater | LEqual | GEqual | Equal | NotEqual | Always

ZTest可以取的值为：Greater/GEqual/Less/LEqual/Equal/NotEqual/Always/Never/Off，默认值为LEqual,ZTest Off 等同于 ZTest Always，代表通过比较深度来更改颜色缓存的值。例如当取默认值的情况下，如果将要绘制的新像素的z值小于等于深度缓存中的值，则将用新像素的颜色值更新深度缓存中对应像素的颜色值。

需要注意的是，当ZTest取值为Off时，表示的是关闭深度测试，等价于取值为Always，而不是Never！Always指的是直接将当前像素颜色(不是深度)写进颜色缓冲区中；而Never指的是不要将当前像素颜色写进颜色缓冲区中，相当于消失。

## 结论：

ZTest通过，ZWrite为On：写入深度缓冲区，写入颜色缓冲区；
ZTest通过，ZWrite为Off：不写深度缓冲区，写入颜色缓冲区；
ZTest失败，ZWrite为On：不写深度缓冲区，不写颜色缓冲区；
ZTest失败，ZWrite为Off：不写深度缓冲区，不写颜色缓冲区；